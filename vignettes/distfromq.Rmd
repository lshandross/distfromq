---
title: "distfromq"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{distfromq}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 8,
  out.width = "100%"
)
```




```{r setup}
library(distfromq)
library(ggplot2)
library(dplyr)
```

```{r}
quantile_probs <- seq(from = 0.1, to = 0.9, by = 0.1)

meanlog <- 4.0
sdlog <- 0.5
q_lognormal <- qlnorm(quantile_probs, meanlog = meanlog, sdlog = sdlog)
```

```{r}
x <- seq(from = 0.0, to = 400.0, length = 501)
cdf_lognormal <- plnorm(x, meanlog = meanlog, sdlog = sdlog)

p_normal_approx <- make_p_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
cdf_normal_approx <- p_normal_approx(x)

p_cauchy_approx <- make_p_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "cauchy",
                             upper_tail_dist = "cauchy")
cdf_cauchy_approx <- p_cauchy_approx(x)

dplyr::bind_rows(
    data.frame(
        x = x,
        y = cdf_lognormal,
        dist = "Log normal"
    ),
    data.frame(
        x = x,
        y = cdf_normal_approx,
        dist = "Spline interpolation,\nnormal tails"
    ),
    data.frame(
        x = x,
        y = cdf_cauchy_approx,
        dist = "Spline interpolation,\nCauchy tails"
    )
) %>%
    ggplot() +
        geom_line(
            mapping = aes(x = x, y = y, color = dist, linetype = dist),
            size = 0.8) +
        geom_point(
            data = data.frame(q = q_lognormal, p = quantile_probs),
            mapping = aes(x = q, y = p),
            size = 1.2
        ) +
        scale_color_viridis_d(
            "Distribution",
            end = 0.9
        ) +
        scale_linetype_discrete("Distribution") +
        ylab("Probability") +
        xlab("") +
        theme_bw()
```

```{r}
d_normal_approx <- make_d_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")

d_cauchy_approx <- make_d_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "cauchy",
                             upper_tail_dist = "cauchy")

pdf_lognormal <- dlnorm(x, meanlog = meanlog, sdlog = sdlog)
pdf_normal_approx <- d_normal_approx(x)
pdf_cauchy_approx <- d_cauchy_approx(x)

dplyr::bind_rows(
    data.frame(
        x = x,
        y = pdf_lognormal,
        dist = "Log normal"
    ),
    data.frame(
        x = x,
        y = pdf_normal_approx,
        dist = "Spline interpolation,\nnormal tails"
    ),
    data.frame(
        x = x,
        y = pdf_cauchy_approx,
        dist = "Spline interpolation,\nCauchy tails"
    )
) %>%
    ggplot() +
        geom_vline(
            data = data.frame(q = q_lognormal),
            mapping = aes(xintercept = q),
            size = 0.2
        ) +
        geom_line(
            mapping = aes(x = x, y = y, color = dist, linetype = dist),
            size = 0.8) +
        scale_color_viridis_d(
            "Distribution",
            end = 0.9
        ) +
        scale_linetype_discrete("Distribution") +
        ylab("Probability Density") +
        xlab("") +
        theme_bw()
```

```{r}
r_normal_approx <- make_r_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
r_cauchy_approx <- make_r_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "cauchy",
                             upper_tail_dist = "cauchy")
                             
normal_approx_sample <- r_normal_approx(n=10000)
cauchy_approx_sample <- r_cauchy_approx(n=10000)

bind_rows(
    data.frame(x=normal_approx_sample, dist = "Spline interpolation,\nnormal tails"),
    data.frame(x=cauchy_approx_sample, dist = "Spline interpolation,\nCauchy tails")
) %>%
    ggplot() +
        geom_density(mapping = aes(x = x, color = dist, linetype = dist)) +
        scale_color_viridis_d(
            "Distribution",
            end = 0.9
        ) +
        scale_linetype_discrete("Distribution") +
        theme_bw()
```


```{r}
bind_rows(
    data.frame(x=normal_approx_sample, dist = "Spline interpolation,\nnormal tails"),
    data.frame(x=cauchy_approx_sample, dist = "Spline interpolation,\nCauchy tails")
) %>%
    ggplot() +
        geom_density(mapping = aes(x = x, color = dist, linetype = dist)) +
        scale_color_viridis_d(
            "Distribution",
            end = 0.9
        ) +
        scale_linetype_discrete("Distribution") +
        xlim(-100, 300) +
        theme_bw()
```

```{r}
x <- seq(from = 0.0, to = 400.0, length = 501)
```

```{r}
ps <- seq(from = 0.01, to = 0.99, by = 0.01)

q_normal_approx <- make_q_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
q_cauchy_approx <- make_q_fn(ps = quantile_probs,
                             qs = q_lognormal,
                             lower_tail_dist = "cauchy",
                             upper_tail_dist = "cauchy")

quantiles_lognormal <- qlnorm(ps, meanlog = meanlog, sdlog = sdlog)
quantiles_normal_approx <- q_normal_approx(ps)
quantiles_cauchy_approx <- q_cauchy_approx(ps)


dplyr::bind_rows(
    data.frame(
        x = ps,
        y = quantiles_lognormal,
        dist = "Log normal"
    ),
    data.frame(
        x = ps,
        y = quantiles_normal_approx,
        dist = "Spline interpolation,\nnormal tails"
    ),
    data.frame(
        x = ps,
        y = quantiles_cauchy_approx,
        dist = "Spline interpolation,\nCauchy tails"
    )
) %>%
    ggplot() +
        geom_line(
            mapping = aes(x = x, y = y, color = dist, linetype = dist),
            size = 0.8) +
        scale_color_viridis_d(
            "Distribution",
            end = 0.9
        ) +
        scale_linetype_discrete("Distribution") +
        ylab("Quantile") +
        xlab("Probability Level") +
        theme_bw()
```

# Duplicated quantiles

When quantile values are the same at multiple probability levels, the distribution assigns non-zero probability to that value, corresponding to a "step" or "jump" in the cumulative distribution function. In this instance, the functions in this package may not behave as expected. First, we note that `make_d_fn` will throw an error because a continuous density does not exist. We also note that the spline interpolation of the cdf used by `make_p_fn` will interpolate the median of the probabilities at that quantile level, rather than producing a step function; a warning about this behavior is issued. Additionally, if the repeated quantile values occur at the extremes that are used for the tail extrapolation, the extrapolated cdf will be exactly 0 in the lower tail or 1 in the upper tail. No warnings or errors are thrown when `make_q_fn` and `make_r_fn` are called. We illustrate these behaviors with two simple examples.

## Example 2: duplicated quantiles on the interior

```{r, error=TRUE}
quantile_probs <- seq(from = 0.1, to = 0.9, by = 0.1)
quantile_values <- c(1.0, 2.0, 3.0, 3.0, 3.0, 3.0, 3.0, 8.0, 9.0)

d_normal_approx <- make_d_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
p_normal_approx <- make_p_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
q_normal_approx <- make_q_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
r_normal_approx <- make_r_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")


x <- seq(from = 0.0, to = 20.0, length = 201)
cdf_normal_approx <- p_normal_approx(x)
ggplot() +
  geom_line(data=data.frame(x=x, y=cdf_normal_approx),
            mapping = aes(x=x, y=y)) +
  geom_point(data=data.frame(x=quantile_values, y=quantile_probs),
             mapping = aes(x=x, y=y))

ps <- seq(from = 0.0, to = 1.0, length = 201)
qf_normal_approx <- q_normal_approx(ps)
ggplot() +
  geom_line(data=data.frame(p=ps, y=qf_normal_approx),
            mapping = aes(x=p, y=y)) +
  geom_point(data=data.frame(x=quantile_probs, y = quantile_values),
             mapping = aes(x=x, y=y))

samples_normal_approx <- r_normal_approx(n = 10000)
mean(samples_normal_approx == 3.0)
```

## Example 3: duplicated quantiles in the tails

```{r}
quantile_probs <- seq(from = 0.1, to = 0.9, by = 0.1)
quantile_values <- c(1.0, 1.0, 3.0, 3.0, 3.0, 3.0, 3.0, 9.0, 9.0)

p_normal_approx <- make_p_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
q_normal_approx <- make_q_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")
r_normal_approx <- make_r_fn(ps = quantile_probs,
                             qs = quantile_values,
                             lower_tail_dist = "norm",
                             upper_tail_dist = "norm")


x <- seq(from = 0.0, to = 20.0, length = 201)

cdf_normal_approx <- p_normal_approx(x)
ggplot() +
  geom_line(data=data.frame(x=x, y=cdf_normal_approx),
            mapping = aes(x=x, y=y)) +
  geom_point(data=data.frame(x=quantile_values, y=quantile_probs),
             mapping = aes(x=x, y=y))
```
